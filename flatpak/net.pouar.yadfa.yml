app-id: net.pouar.yadfa
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
command: /app/bin/yadfa
cleanup:
  - /tmp
  - /bin/wget
  - /etc
  - /share/runtime
  - /share/locale
  - /share/man
  - /lib/debug
  - /lib/yadfa/ci
  - /lib/yadfa/flatpak
  - /lib/yadfa/.*
  - /lib/yadfa/appveyor-*.lisp
finish-args:
  - --share=ipc
  - --socket=x11
  - --share=network
  - --device=dri
build-options:
  build-args:
    - --share=network
modules:
  - name: wget
    buildsystem: autotools
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/wget/wget-1.19.5.tar.lz
        sha256: 29fbe6f3d5408430c572a63fe32bd43d5860f32691173dfd84edc06869edca75
  - name: tinytex
    buildsystem: simple
    build-commands:
      - bash -c 'TEXDIR=/app/tmp/texlive;wget -qO- https://github.com/yihui/tinytex/raw/master/tools/install-base.sh | sh -s - "$@";rm -rf $TEXDIR;mkdir -p $TEXDIR;mv texlive/* $TEXDIR;rm -r texlive;$TEXDIR/bin/*/tlmgr install $(wget -qO- https://github.com/yihui/tinytex/raw/master/tools/pkgs-custom.txt | tr "\n" " ") texinfo;$TEXDIR/bin/*/tlmgr path add'
    sources:
      - type: archive
        sha256: 3ff6c23f51c7cfb40f1fbdfaf25d0c1bfbe08ddea41919d7d1fafcfb953c1b39
        url: https://github.com/yihui/tinytex/archive/v0.9.tar.gz
  - name: sbcl-bin
    buildsystem: simple
    build-commands:
      - INSTALL_ROOT="/app/tmp/sbcl-bin" sh install.sh
      - printf "#!/bin/sh\necho net.pouar.yadfa\n"  > /app/tmp/sbcl-bin/bin/hostname
      - chmod +x /app/tmp/sbcl-bin/bin/hostname
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/sbcl/sbcl/1.4.15/sbcl-1.4.15-x86-64-linux-binary.tar.bz2
        sha256: f3be1d05db692013a8f153bb8ac452d5e34b62a2aab0284a7adaad6966872747
  - name: sbcl
    buildsystem: simple
    build-commands:
      - sed -i 's|if $GNUMAKE -C contrib/$i test < /dev/null|if $GNUMAKE -C contrib/$i < /dev/null|' make-target-contrib.sh
      - sh -c 'echo "root:x:0:0:root,,,,:/root:/bin/sh" >> /etc/passwd;echo "root:x:0:root" >> /etc/group;SBCL_HOME="/app/tmp/sbcl-bin/lib/sbcl" PATH="$PATH:/app/tmp/sbcl-bin/bin" HOME="/app/tmp/home/" sh make.sh sbcl --fancy --with-sb-fasteval --without-sb-eval --with-sb-unicode --with-largefile'
      - INSTALL_ROOT="/app/tmp/sbcl" HOME="/app/tmp/home/" sh install.sh
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/sbcl/sbcl/1.4.15/sbcl-1.4.15-source.tar.bz2
        sha256: 486c3bcf1338d0023be93725bac2ac298811cd30a5e2b94d7491ddad1fa1372e
  - name: yadfa-deps
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/home/common-lisp
      - cp -R asdf-*/ /app/tmp/home/common-lisp/asdf/
      - SBCL_HOME="/app/tmp/sbcl/lib/sbcl" PATH="$PATH:/app/tmp/sbcl/bin" HOME="/app/tmp/home/" sbcl --quit --load "quicklisp.lisp" --eval "(quicklisp-quickstart:install)"
      - mkdir -p /app/tmp/home/quicklisp/local-projects
      - cp -R declt/ /app/tmp/home/quicklisp/local-projects/declt/
      - cp -R McCLIM/ /app/tmp/home/quicklisp/local-projects/McCLIM/
      - cp -R sly/ /app/tmp/home/quicklisp/local-projects/sly/
    sources:
      - type: file
        url: https://beta.quicklisp.org/quicklisp.lisp
        sha256: 4a7a5c2aebe0716417047854267397e24a44d0cce096127411e9ce9ccfeb2c17
      - type: archive
        url: https://gitlab.common-lisp.net/asdf/asdf/-/archive/3.3.2.13/asdf-3.3.2.13.tar.gz
        strip-components: 0
        dest-filename: asdf.tar.gz
        sha256: 72e07870c6986e3604f1147541687530e4100cdabff9513282800625cf66cb07
      - type: git
        url: https://github.com/didierverna/declt.git
        dest: declt
      - type: git
        dest: McCLIM
        url: https://github.com/McCLIM/McCLIM.git
      - type: git
        dest: sly
        url: https://github.com/joaotavora/sly.git
  - name: yadfa-cache
    buildsystem: simple
    build-commands:
      - SBCL_HOME="/app/tmp/sbcl/lib/sbcl" PATH="$PATH:/app/tmp/sbcl/bin" HOME="/app/tmp/home/" sbcl --quit --eval "(progn (require 'sb-gmp) (sb-gmp:install-gmp-funs))" --eval '(let ((quicklisp-init (merge-pathnames "quicklisp/setup.lisp" (user-homedir-pathname)))) (when (probe-file quicklisp-init) (load quicklisp-init)))' --eval '(progn (ql:update-client) (ql:update-all-dists) (pushnew :mcclim-ffi-freetype *features*) (pushnew :ironclad *features*) (pushnew :yadfa/docs *features*) (pushnew :yadfa/mods *features*) (ql:quickload :swank) (ql:quickload :mcclim) (ql:quickload :marshal) (ql:quickload :iterate) (ql:quickload :ugly-tiny-infix-macro) (ql:quickload :closer-mop) (ql:quickload :trivial-features) (ql:quickload :ironclad) (ql:quickload :clim-listener) (ql:quickload :trivial-garbage) (ql:quickload :macro-level) (ql:quickload :cl-ansi-text) (ql:quickload :alexandria) (ql:quickload :net.didierverna.declt) (ql:quickload :sb-aclrepl))'  --eval "(sb-ext:gc :full t)" --eval '(sb-ext:save-lisp-and-die "/app/tmp/sbcl/lib/sbcl/sbcl.core" :purify t)'
  - name: yadfa
    buildsystem: simple
    build-commands:
      - ln -s $PWD /app/tmp/home/quicklisp/local-projects/yadfa
      - SBCL_HOME="/app/tmp/sbcl/lib/sbcl" PATH="$PATH:/app/tmp/sbcl/bin" HOME="/app/tmp/home/" sbcl --script build.lisp mods texi ironclad ft
      - HOME="/app/tmp/home/" ./yadfa texi
      - bash -c 'cd docs/reference;HOME="/app/tmp/home/" makeinfo --no-split --css-include=style-common.css --css-include=style-single.css --html ./yadfa-reference.texi'
      - bash -c 'cd docs/reference;export HOME="/app/tmp/home/" PATH="/app/tmp/texlive/bin/x86_64-linux:$PATH" PDFTEX=xetex PDFLATEX=xelatex;makeinfo --no-split --pdf ./yadfa-reference.texi'
      - bash -c 'cd docs/reference;HOME="/app/tmp/home/" makeinfo --no-split ./yadfa-reference.texi'
      - install -dm755 /app/lib/yadfa
      - git archive HEAD|tar -xf - -C /app/lib/yadfa/
      - cp yadfa /app/lib/yadfa/
      - rm /app/tmp/home/quicklisp/local-projects/yadfa
      - mkdir -p /app/bin /app/share/doc/yadfa /app/share/info /app/share/icons/hicolor/scalable/apps /app/share/applications /app/share/metainfo /app/lib
      - install -Dm644 docs/reference/yadfa-reference.html /app/share/doc/yadfa/
      - install -Dm644 docs/reference/yadfa-reference.pdf /app/share/doc/yadfa/
      - gzip -c docs/reference/yadfa-reference.info > /app/share/info/yadfa-reference.info.gz
      - cp flatpak/net.pouar.yadfa.svg /app/share/icons/hicolor/scalable/apps/net.pouar.yadfa.svg
      - cp flatpak/net.pouar.yadfa.appdata.xml /app/share/metainfo/net.pouar.yadfa.appdata.xml
      - cp flatpak/net.pouar.yadfa.desktop /app/share/applications/net.pouar.yadfa.desktop
      - ln -s /app/lib/yadfa/yadfa /app/bin/yadfa
      - bash -c 'LIB="$(readlink /lib/x86_64-linux-gnu/libfreetype.so)"; ln -s "/lib/x86_64-linux-gnu/${LIB%.[0-9]*.[0-9]*}" /app/lib/libfreetype.so'
      - bash -c 'LIB="$(readlink /lib/x86_64-linux-gnu/libfontconfig.so)"; ln -s "/lib/x86_64-linux-gnu/${LIB%.[0-9]*.[0-9]*}" /app/lib/libfontconfig.so'
      - bash -c 'LIB="$(readlink /lib/x86_64-linux-gnu/libharfbuzz.so)"; ln -s "/lib/x86_64-linux-gnu/${LIB%.[0-9]*.[0-9]*}" /app/lib/libharfbuzz.so'
    sources:
      - type: git
        branch: master
        url: https://git.pouar.net/yadfa.git
